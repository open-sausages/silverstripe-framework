---
Name: coreflysystem
---
Injector:
  # Public url plugin
  FlysystemUrlPlugin:
    class: 'SilverStripe\Filesystem\Flysystem\FlysystemUrlPlugin'
  # Define the default adapter for this filesystem
  FlysystemDefaultAdapter:
    class: 'SilverStripe\Filesystem\Flysystem\AssetAdapter'
  # Define the secondary adapter for protected assets
  FlysystemProtectedAdapter:
    class: 'SilverStripe\Filesystem\Flysystem\ProtectedAssetAdapter'
  # Define the default filesystem
  FlysystemBackend:
    class: 'League\Flysystem\Filesystem'
    constructor:
      Adapter: '%$FlysystemDefaultAdapter'
      Config:
        visibility: public
    calls:
      PublicURLPlugin: [ addPlugin, [ %$FlysystemUrlPlugin ] ]
  # Define the secondary filesystem for protected assets
  FlysystemProtectedBackend:
    class: 'League\Flysystem\Filesystem'
    constructor:
      Adapter: '%$FlysystemProtectedAdapter'
      Config:
        visibility: private
    calls:
      PublicURLPlugin: [ addPlugin, [ %$FlysystemUrlPlugin ] ]
---
Name: coreassets
After:
  - '#coreflysystem'
---
Injector:
  # Define our SS asset backend
  AssetStore:
    class: 'SilverStripe\Filesystem\Flysystem\FlysystemAssetStore'
    properties:
      PublicFilesystem: '%$FlysystemBackend'
      ProtectedFilesystem: '%$FlysystemProtectedBackend'
  ProtectedFileController:
    class: SilverStripe\Filesystem\Storage\ProtectedFileController
    properties:
      RouteHandler: '%$AssetStore'
  AssetNameGenerator:
    class: SilverStripe\Filesystem\Storage\DefaultAssetNameGenerator
    type: prototype
  # Requirements config
  GeneratedAssetHandler:
    class: SilverStripe\Filesystem\Storage\FlysystemGeneratedAssetHandler
    properties:
      Filesystem: '%$FlysystemBackend'
  Requirements_Minifier:
    class: SilverStripe\View\JSMinifier
  Requirements_Backend:
    properties:
      AssetHandler: '%$GeneratedAssetHandler'
---
Name: coreassetroutes
After:
  - '#coreassets'
---
Director:
  rules:
    'assets': 'ProtectedFileController'
---
Name: imageconfig
---
Injector:
  Image_Backend: GDBackend
